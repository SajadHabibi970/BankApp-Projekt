@page "/history"
@using BlazorApp2.Interfaces
@using BlazorApp2.Services
@using BlazorApp2.Domain
@inject IAccountService AccountService
@inject ITransactionService TransactionService
<h3>Historik</h3>

<!--JSON export och import av alla bankdata-->
<div class="mb-3">
    <button class="btn btn-outline-success me-2" @onclick="ExportData">Exportera JSON</button>
    <button class="btn btn-outline-secondary" @onclick="ImportData">Importera JSON</button>
</div>

@if (_accounts == null || !_accounts.Any())
{
    <p>Du har inga konton ännu. Skapa ett konto först.</p>
}
else
{
    <!--Filter och sorteringskontroller-->
    <div class="d-flex flex-wrap gap-3 mb-3">
        <div>
            <label class="form-label fw-bold">Filtrera per konto:</label>
            <select class="form-select" @onchange="OnAccountChanged">
                <option value="">Alla konton</option>
                @foreach (var acc in _accounts)
                {
                    <option value="@acc.Id" selected="@(_selectedAccountId == acc.Id.ToString())">
                        @acc.Name (@acc.Currency)
                    </option>
                }
            </select>
        </div>
        
        <!--Välj sorteringsordning-->
        <div>
            <label class="form-label fw-bold">Sortera efter:</label>
            <select class="form-select" @onchange="OnSortChanged">
                <option value="DateDesc" selected="@(_sortBy == "DateDesc")">Datum (nyast först)</option>
                <option value="DateAsc" selected="@(_sortBy == "DateAsc")">Datum (äldst först)</option>
                <option value="AmountDesc" selected="@(_sortBy == "AmountDesc")">Belopp (högst först)</option>
                <option value="AmountAsc" selected="@(_sortBy == "AmountAsc")">Belopp (lägst först)</option>
            </select>
        </div>
        
        <!--Datum filtering-->
        <div>
            <label class="form-label fw-bold">Från Datum</label>
            <InputDate class="form-control" @bind-Value="_fromDate"/>
        </div>
        
        <div>
            <label class="form-label fw-bold">Till datum</label>
            <InputDate class="form-control" @bind-Value="_toDate"/>
        </div>
    </div>
    
    <!--Knapp som aktiverar datumfiltering-->
    <div class="d-flex align-items-end">
        <button class="btn btn-outline-primary" @onclick="ApplyDateFilter">
            Filtera datum
        </button>
    </div>

    @if (_transactions == null || !_transactions.Any())
    {
        <p>Inga transaktioner hittades för det valda filtret.</p>
    }
    else
    {
        <!-- Tabell som visar transaktionshistorik-->
        <table class="table table-striped align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Datum</th>
                    <th>Konto</th>
                    <th>Typ</th>
                    <th>Belopp</th>
                    <th>Saldo efter</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var t in _transactions)
                {
                    var konto = _accounts.FirstOrDefault(a => a.Id == t.AccountId);
                    
                    string typText;
                    string typeClass;

                    <!--Färglägg beroende på typ-->
                    switch (t.Type)
                    {
                        case TransactionType.Deposit:
                            if (!string.IsNullOrEmpty(t.Description) && t.Description.Contains
                                    ("Ränta", StringComparison.OrdinalIgnoreCase))
                            {
                                typText = "Ränta";
                                typeClass = "text-info fw-bold";
                            }
                            else
                            {
                                typText = "Insättning";
                                typeClass = "text-success fw-bold";
                            }
                            break;

                        case TransactionType.Withdraw:
                            typText = "Uttag";
                            typeClass = "text-danger fw-bold";
                            break;

                        case TransactionType.Transfer:
                            if (t.Description.StartsWith("Från"))
                            {
                                typText = "Överföring in";
                                typeClass = "text-success fw-bold";
                            }
                            else
                            {
                                typText = "Överföring ut";
                                typeClass = "text-danger fw-bold";
                            }
                            break;

                        default:
                            typText = t.Type.ToString();
                            typeClass = "";
                            break;
                    }

                    <!--Rad för varje transaktion-->
                    <tr>
                        <td>@t.Date.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td>
                        <td>@konto?.Name</td>
                        <td class="@typeClass">@typText</td>
                        <td class="@typeClass">@t.Amount.ToString("N2")</td>
                        <td>@t.BalanceAfter.ToString("N2")</td>
                    </tr>
                }
            </tbody>
        </table>
    }
}

@code {
    private List<IBankAccount> _accounts = new();
    private List<BlazorApp2.Domain.Transaction> _transactions = new();
    private DateTime? _fromDate = null;
    private DateTime? _toDate = null;
    private string _selectedAccountId = "";
    private string _sortBy = "DateDesc";

    /// <summary>
    /// Körs vid sidladdning
    /// Hämtar konton och transaktioner
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        _accounts = await AccountService.GetAccounts();
        await LoadTransactionsAsync();
    }

    /// <summary>
    /// Laddar transaktioner baserat på valt konto och sortering
    /// </summary>
    private async Task LoadTransactionsAsync()
    {
        if (string.IsNullOrWhiteSpace(_selectedAccountId))
        {
            _transactions = await TransactionService.GetAllAsync();
        }
        else if (Guid.TryParse(_selectedAccountId, out var accountId))
        {
            _transactions = await TransactionService.GetByAccountIdAsync(accountId);
        }
        else
        {
            _transactions = new();
        }

        SortTransactions();
    }
    
    private async Task OnAccountChanged(ChangeEventArgs e)
    {
        _selectedAccountId = e.Value?.ToString() ?? "";
        _fromDate = null;
        _toDate = null;
        await LoadTransactionsAsync();
    }

    private void OnSortChanged(ChangeEventArgs e)
    {
        _sortBy = e.Value?.ToString() ?? "DateDesc";
        SortTransactions();
    }

    /// <summary>
    /// Sorterar transaktionslistan enligt valt alternativ
    /// </summary>
    private void SortTransactions()
    {
        _transactions = _sortBy switch
        {
            "DateAsc" => _transactions.OrderBy(t => t.Date).ToList(),
            "DateDesc" => _transactions.OrderByDescending(t => t.Date).ToList(),
            "AmountAsc" => _transactions.OrderBy(t => t.Amount).ToList(),
            "AmountDesc" => _transactions.OrderByDescending(t => t.Amount).ToList(),
            _ => _transactions
        };

        StateHasChanged();
    }

    // Inject av export och import service
    [Inject] private DataExportService ExportService { get; set; } = null!;
    [Inject] IJSRuntime JSRuntime { get; set; } = default!;

    /// <summary>
    /// Exporterar alla konton och transaktioner till JSON
    /// Kopierar resultatet till urklipp
    /// </summary>
    private async Task ExportData()
    {
        var json = await ExportService.ExportAsync();
        await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", json);
        await JSRuntime.InvokeVoidAsync("alert", "Export klar!");
    }

    /// <summary>
    /// Importerar JSON data som användare klistrar in
    /// Efter import allt laddas igen och visas direkt
    /// </summary>
    private async Task ImportData()
    {
        var json = await JSRuntime.InvokeAsync<string>("prompt", "Klistra in JSON-data att importera:");
        if (!string.IsNullOrWhiteSpace(json))
        {
            await ExportService.ImportAsync(json);
            await LoadTransactionsAsync();
            await JSRuntime.InvokeVoidAsync("alert", "Import slutförd");
        }
    }

    /// <summary>
    /// Filterar transaktionerna baserat på valt datuminterval
    /// </summary>
    private void ApplyDateFilter()
    {
        if (_transactions == null || !_transactions.Any())
        {
            return;
        }

        var filtered = _transactions.AsQueryable();

        if (_fromDate.HasValue)
        {
            filtered = filtered.Where(t => t.Date.Date <= _toDate.Value.Date);
        }

        _transactions = filtered.ToList();
        
        SortTransactions();
    }

}